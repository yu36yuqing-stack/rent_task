# PRD - ORDER

## 订单冷却期（复用黑名单通道）方案记录

### 1. 目标
- 在不改动现有“黑名单执行链路（强制下架 + 阻断上架）”的前提下，新增一种可自动进出的冷却类型。
- 用于处理订单结束后短时间内不要立即上架的问题。

### 2. 设计原则
- 复用 `user_blacklist` 通道，不新增一套并行动作引擎。
- 新增黑名单类型（`reason`）用于区分展示文案，避免误导成手工黑名单。
- 只调整“进出黑名单”的判定逻辑。

### 3. 新增类型
- `reason = 冷却期下架`
- 语义：订单冷却期内，账号应保持全渠道下架/阻断上架。

### 4. 进黑名单规则（订单同步任务）
- 执行任务：订单同步任务（当前 10 分钟频率）。
- 触发条件：
  1. 订单状态属于有效租赁（排除取消/无效订单）。
  2. `now >= order_start_time + 10 分钟`。
- 入黑名单动作：
  1. 写入/更新 `reason=冷却期下架`。
  2. 计算并保存 `cooldown_until = order_end_time + 10 分钟`。
- 设计依据：租号订单通常 1 小时起租且前 10 分钟取消率高，10 分钟后再进入冷却控制更有业务意义。

### 5. 出黑名单规则（商品同步任务）
- 建议执行任务：商品同步任务（当前 5 分钟频率）。
- 释放判断字段：使用预先计算并保存的 `cooldown_until`。
- 释放条件：`now >= cooldown_until` 时，移除“冷却期下架”类型。
- 删除粒度：仅删除该冷却类型，不影响手工黑名单/X 单下架等其他类型。

### 6. 为什么出黑名单放在商品任务
- 若放在订单任务（10 分钟频率），`结束+10分钟` 的实际恢复可能出现较大延迟（最坏可接近额外 10 分钟，体感接近 20 分钟）。
- 放在商品任务（5 分钟频率）可明显降低恢复延迟，恢复更平滑。

### 7. 安全保护（避免提前释放）
- 商品任务在释放前增加“订单数据新鲜度”校验：
  - 仅当最近一次订单同步成功且在新鲜窗口内（如 12 分钟）才允许释放。
  - 若订单同步滞后，本轮不释放，等待下轮，避免因订单视图过期导致提前上架。

### 8. 多订单与幂等处理
- 同账号多订单并存时：
  - `cooldown_until` 取最大值（更晚时间优先），新订单只延后不缩短。
- 幂等策略：
  - 入场采用 upsert（已有记录则更新截止时间）。
  - 出场按“账号 + 类型（冷却期下架）”精确删除。

### 9. 当前结论（讨论阶段）
- 已确认：
  1. 黑名单通道可复用。
  2. 冷却期命中时应执行下架。
  3. 展示文案按 `reason` 区分为“冷却期下架”。
- 待实现：
  1. `cooldown_until` 的最终落库位置（建议可查询、可更新）。
  2. 订单“有效租赁状态”枚举的最终口径。
  3. 订单数据新鲜度窗口阈值（建议先用 12 分钟）。
