# PROD_GUARD_PRD

## 2026-02-24

### 功能点1：在线状态查询与异常告警拆分

- 背景：
  - 目前“在线状态查询结果展示”与“在线但非租赁中异常告警”逻辑耦合，导致主通知中查询信息缺失。
  - 业务期望是两类通知分离：
    - 商品状态主通知按 5 分钟节奏持续发送。
    - 在线状态查询结果按 10 分钟节奏附加在主通知中。
    - “在线但非租赁中”属于异常告警，只有命中异常才单独通知，无异常静默。

- 目标：
  - 保持 5 分钟商品状态主通知不受影响。
  - 每 10 分钟在主通知中增加“在线状态查询结果摘要”区块（查询成功/失败、ON/OFF数量等）。
  - 异常告警仍独立发送，且无异常不额外发告警消息。

- 方案：
  - 在 `product/prod_status_guard.js` 拆分能力：
    - 探测层：只做在线状态查询并返回快照结果（不发告警）。
    - 告警层：基于探测快照判断“在线且非租赁中”，并执行告警发送。
  - 主流程 `rent_robot_main.js`：
    - 每次 5 分钟主流程都发商品状态通知。
    - 命中 10 分钟探测窗口时，将在线探测摘要注入主通知 payload。
    - 告警逻辑异步触发，并复用同一份探测快照，避免重复调用平台查询接口。
  - 通知模板 `report/telegram/tg_style.js` 与 `report/dingding/ding_style.js`：
    - 新增“在线状态查询(10分钟)”展示区块。
    - 仅在本次命中探测窗口且有查询结果时展示。

- 验收：
  - 每 5 分钟可收到商品状态主通知。
  - 每隔 10 分钟的主通知包含在线查询摘要。
  - 无“在线但非租赁中”异常时，不发送额外异常告警。
  - 命中异常时，发送独立异常告警。
